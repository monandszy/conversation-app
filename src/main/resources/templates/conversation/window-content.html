<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
>
<head>
  <title>Window Content</title>
</head>
<th:block th:fragment="fragment(sectionPage)">
  <div th:each="section : ${sectionPage.content}" th:classappend="section">
    <th:block th:each="request : ${section.requests}">
      <div th:replace="~{conversation/window-content :: request-content-fragment(${request}, ${section.id})}"></div>
      <div class="response-wrapper">
        <th:block th:each="response : ${request.responses}">
          <div
            th:replace="~{conversation/window-content :: response-content-fragment(${response}, ${request.id})}"
          ></div>
        </th:block>
      </div>
    </th:block>
  </div>
</th:block>

<th:block th:fragment="request-fragment">
  <div class="section">
    <div th:replace="~{conversation/window-content :: request-content-fragment(${requestReadDto}, ${sectionId})}"></div>
    <div class="response-wrapper">
      <th:block th:each="response : ${requestReadDto.responses}">
        <div
          th:replace="~{conversation/window-content :: response-content-fragment(${response}, ${requestReadDto.id})}"
        ></div>
      </th:block>
    </div>
  </div>
</th:block>
<th:block th:fragment="response-fragment">
  <div class="response-wrapper">
    <div
      th:replace="~{conversation/window-content :: response-content-fragment(${responseReadDto}, ${requestId})}"
    ></div>
  </div>
</th:block>

<th:block th:fragment="request-content-fragment(request, sectionId)">
  <div hx-include="this">
    <p
      th:text="${request.text}" class="request"
      contenteditable="true"
      hx-trigger="keydown[ctrlKey&&key=='Enter'] from:.request"
      th:hx-post="'/conversation/section/' + ${sectionId}"
      hx-target="closest .section"
      hx-swap="outerHTML"
      oninput="updateHiddenInput(this)"
    ></p>
    <input id="hidden-input" type="hidden" name="text"/>
  </div>
  <th:block th:if="${request.navigation.previousId != null}">
    <button
      th:text="previous"
      th:hx-get="'/conversation/section/' + ${sectionId} + '/request/' + ${request.navigation.previousId}"
      hx-target="closest .section"
      hx-swap="outerHTML"
    ></button>
  </th:block>
  <th:block th:if="${request.navigation.nextId != null}">
    <button
      th:text="next"
      th:hx-get="'/conversation/section/' + ${sectionId} + '/request/' + ${request.navigation.nextId}"
      hx-target="closest .section"
      hx-swap="outerHTML"
    ></button>
  </th:block>
</th:block>

<th:block th:fragment="response-content-fragment(response, requestId)">
  <p th:text="${response.text}" class="response"></p>
  <th:block th:if="${response.navigation.previousId != null}">
    <button
      th:text="previous"
      th:hx-get="'/conversation/request/' + ${requestId} + '/response/' + ${response.navigation.previousId}"
      hx-target="closest .response-wrapper"
      hx-swap="outerHTML"
    ></button>
  </th:block>
  <th:block th:if="${response.navigation.nextId != null}">
    <button
      th:text="next"
      th:hx-get="'/conversation/request/' + ${requestId} + '/response/' + ${response.navigation.nextId}"
      hx-target="closest .response-wrapper"
      hx-swap="outerHTML"
    ></button>
  </th:block>
  <button
    th:text="retry"
    th:hx-post="'/conversation/request/' + ${requestId}"
    hx-target="closest .response-wrapper"
    hx-swap="outerHTML"
  ></button>
</th:block>
</html>